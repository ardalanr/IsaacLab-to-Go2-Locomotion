# Sim-to-Real RL Policy Deployment Unitree Go2

## Overview 

This repository is forked from [walk-these-ways-go2](https://github.com/Teddy-Liao/walk-these-ways-go2), which is a Go2 Sim-to-Real locomotion pipeline. 

This project aims to train and deploy RL locomotion policies trained using IsaacLab using the [walk-these-ways](https://github.com/Improbable-AI/walk-these-ways) code on the Unitree Go2.

## Requirements 
* miniconda
* pytorch 1.10 with cuda-11.3
* Isaac Gym
* Nvidia GPU with at least 8GB of VRAM

### Dependencies
#### Install LCM
Since [walk-these-ways](https://github.com/Improbable-AI/walk-these-ways) implement an interface based on Lightweight Communications and Marshalling ([LCM](https://github.com/lcm-proj/lcm)) to pass sensor data, motor commands, and joystick state between their code and the low-level control SDK provided by Unitree, LCM should be installed firstly in your PC or laptlop.

Clone LCM repository to any location (where you usually place installed softwares), then install LCM:
```bash
git clone https://github.com/lcm-proj/lcm.git
mkdir build
cd build
cmake ..
make
sudo make install
```

#### Unitree_SDK2
unitree_sdk2 has been inclued in `go2_gym_deploy/unitree_sdk2_bin/library/unitree_sdk2`,  you can also clone from [Unitree Robotics](https://github.com/unitreerobotics/unitree_sdk2) to make sure the sdk is updated version.

```bash
cd go2_gym_deploy/unitree_sdk2_bin/library/unitree_sdk2
```
Delete build file
```bash
rm -r build
```
Install and build:
```bash
sudo ./install.sh
mkdir build
cd build
cmake ..
make
```

---
Clone this repository and install:

``` bash
git clone https://github.com/ardalanr/walk-these-ways-go2.git
cd walk-these-ways-go2
pip install -e .
```

### Build lcm_position_go2
`go2_gym_deploy/unitree_sdk2_bin/lcm_position_go2.cpp` is the core file of this project, which is similar to `lcm_position.cpp` in [walk-these-ways](https://github.com/Improbable-AI/walk-these-ways), but replace unitree_legged_sdk with unitree_sdk2.

Build lcm_position_go2 and generate runfile `lcm_position_go2`
```bash
cd go2_gym_deploy
rm -r build
mkdir build
cd build
cmake ..
make -j
```

All LCM messages files in `go2_gym_deploy/lcm_types` are set as the same format shown in [walk-these-ways](https://github.com/Improbable-AI/walk-these-ways) to ensure successful connection with python files. LCM message files are provided in this project, and you can also generate customized LCM message files through the following instructions: 

`xxx_lcmt.hpp` files are generated by:
```bash
lcm-gen -x xxx.lcm
```

### Verify connection
Connect your PC/Laptop with Go2 robot with ethernet cable and check connection by:
```bash
ping 192.168.123.161
```

Check the network interface address, and copy the network interface address.
```bash
ifconfig
```
If error occurs, please check [Unitree Support](https://support.unitree.com/home/zh/developer/Quick_start) for details.

### Start LCM
Before starting LCM, ensure that AI sport mode is disabled. 

```bash
cd go2_gym_deploy/build
sudo ./lcm_position_go2 eth0
```
Replace `eth0` with your own network interface address. According to the messages shown in terminal, press `Enter` for several times and the communication between LCM and unitree_sdk2 will set up.

This command will automatically shut down the Unitree sport_mode Service and set the robot to LOW-LEVEL. Please make sure This will Go2 is hung up or lie on the ground.

**At this point, no sport mode service should be enabled.**


### Load and run policy
Open a new terminate and run:
```bash
cd go2_gym_deploy/scripts
python deploy_policy.py
```
Press the [R2] button to start the controller. You can check RC mapping in the following subsection.


### Joystick Mapping

![Joystick Mapping](media/rc_map.png)


To view the details of joystick mapping or even modify default mapping logic, please refer to the `get_command` function within the [cheetah_state_estimator.py](go2_gym_deploy/utils/cheetah_state_estimator.py) file. 


**Caution**:
* Press [L2+B] to switch to damping mode if any unexpected situation occurs!!!
* This is research code; use at your own risk. We do not take responsibility for any damage.

---
## Deploy on Nvidia Jetson Orin

The Unitree Go2 robot is equipped with an onboard Nvidia Jetson Orin Nano/NX, which operates on an ARM-based architecture. The default information of this onboard computer is shown below, and you can connnect to Jetson by SSH, VScode (remote development) or plugging in an HDMI cable.

```
IP:192.168.123.18
user name：unitree
password：123
```

### Requirements for Jetson
- cuda
- pytorch
- miniconda (Omitted here; please install it by yourself)
- cudnn (Omitted here; please install it by yourself)


Two different ways are provided to set up correct environments in Jetson: through Internet or through Docker.

### Through Internet
Connecting a Nvidia Jetson device to the internet can be done in two primary ways:

1. **Wired Connection**: Directly plug an Ethernet cable with internet access into the Jetson's Ethernet port. This method provides a stable and fast internet connection, suitable for tasks that require high bandwidth or low latency.

2. **Wireless Connection via USB Wi-Fi Adapter**: Purchase a USB Wi-Fi adapter compatible with the Jetson device. This method adds wireless connectivity, offering the flexibility to connect to the internet without the need for physical cables. However, it's important to ensure the USB Wi-Fi adapter is supported by the Jetson's operating system and drivers.



#### Check Jetpack Version
Jetpack toolbox has been preinstalled on Jetson, you should check the jetpack vertsion firstly.
```bash
sudo -H pip install jetson-stats  #Install jetson-stats toolkit
sudo jtop
```
According to the detail information printed in the terminal window, the Jetpack version of my Unitree Go2 is `Jetpack 5.1.1 [L4T 35.3.1]`

![](media/sudo_jtop.png)

You can also check libraries that have been preinstalled: 
```bash
sudo jetson_release
```
#### Install cuda for jetson
Check if there is a preinstalled version of cuda. 
```bash
nvcc -V # check preinstalled cuda version
```

If the preinstalled version if too high, you should uninstall it because, for instance, there is no Pytorch version that is compatible with cuda-12.2.

```bash
sudo apt-get remove cuda
sudo apt autoremove 
sudo apt-get remove cuda*
sudo dpkg -l |grep cuda # check if any residual cuda file exists
sudo dpkg -P Residual filename
```

Personally, I recommend to install cuda-11.8. Click the link, [CUDA Toolkit 11.8 Downloads](https://developer.nvidia.com/cuda-11-8-0-download-archive?target_os=Linux&target_arch=aarch64-jetson&Compilation=Native&Distribution=Ubuntu&target_version=20.04&target_type=deb_local) , to check installation commands.

#### Install Pytorch for Jetson

Please [download](https://forums.developer.nvidia.com/t/pytorch-for-jetson/72048) pre-built PyTorch pip wheel installers for Jetson Nano, which is different from the way we install Pytorch on PC. Note that correct pytorch version should be chosen to make it compatible with specific version of cuda and Jetpack. 

#### Install LCM for Jetson
The latest version of LCM (1.5.1) is incompatible with Ubuntu 20.04, so you must install version 1.5.0 using the same method as above.

#### Run codes without cable
As long as the environment and requirements on the Jetson are properly configured, you can follow the same deployment guidelines as you would on a PC. This liberates the robot! Now, you can test the code cable-free, offering more freedom to the robot's movements and applications.

## Credits

This project is a fork of the `go2_gym` repository by Dengting Liao. 
It has been modified by [Your Name] to include [brief description of your changes].
